name: Sync PassWall Version Tag

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  actions: write
  contents: write

jobs:
  sync-tag:
    runs-on: ubuntu-latest
    concurrency:
      group: ${{ github.workflow }}
      cancel-in-progress: false
    steps:
      - name: Sync latest upstream stable tag
        id: upstream
        uses: actions/github-script@v8
        with:
          github-token: ${{ github.token }}
          script: |
            const upstreamOwner = 'Openwrt-Passwall'
            const upstreamRepo = 'openwrt-passwall'
            const { owner, repo } = context.repo
            const headSha = context.sha

            const { data: release } = await github.rest.repos.getLatestRelease({
              owner: upstreamOwner,
              repo: upstreamRepo
            })
            const upstreamTag = (release.tag_name || '').trim()
            if (!upstreamTag) {
              core.setFailed('Upstream latest stable tag is empty')
              return
            }
            const tag = upstreamTag.replace(/^v/, '')
            core.setOutput('tag', tag)
            core.setOutput('upstream_tag', upstreamTag)

            const shortRef = `tags/${tag}`
            try {
              await github.rest.git.getRef({ owner, repo, ref: shortRef })
              core.info(`Tag ${tag} already exists, skip.`)
              core.setOutput('created', 'false')
              return
            } catch (error) {
              if (error.status !== 404) throw error
            }

            try {
              await github.rest.git.createRef({
                owner,
                repo,
                ref: `refs/${shortRef}`,
                sha: headSha
              })
              core.info(`Pushed new tag ${tag}.`)
              core.setOutput('created', 'true')
            } catch (error) {
              const message = error?.response?.data?.message || error?.message || ''
              if (error.status === 422 && message.includes('Reference already exists')) {
                core.info(`Tag ${tag} already created by another run, skip.`)
                core.setOutput('created', 'false')
                return
              }
              throw error
            }

      - name: Summary
        if: always()
        run: |
          echo "- Upstream tag: \`${{ steps.upstream.outputs.upstream_tag }}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- Synced local tag: \`${{ steps.upstream.outputs.tag }}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- Created new tag: \`${{ steps.upstream.outputs.created }}\`" >> "$GITHUB_STEP_SUMMARY"

      - name: Trigger build workflow
        if: steps.upstream.outputs.created == 'true'
        uses: actions/github-script@v8
        with:
          github-token: ${{ github.token }}
          script: |
            const { owner, repo } = context.repo
            const tag = '${{ steps.upstream.outputs.tag }}'
            await github.rest.actions.createWorkflowDispatch({
              owner,
              repo,
              workflow_id: 'build-installer.yml',
              ref: `refs/tags/${tag}`
            })
            core.info(`Triggered build-installer.yml on tag ${tag}.`)
