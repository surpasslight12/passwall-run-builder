name: Build PassWall Installer

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-installer:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Load OpenWrt SDK config
        run: |
          if [ -f config/openwrt-sdk.conf ]; then
            echo "Using config/openwrt-sdk.conf as OpenWrt SDK config"
            # 文件内容为 KEY=VALUE 形式，直接写入 GITHUB_ENV 供后续步骤使用
            cat config/openwrt-sdk.conf | grep -v '^#' | sed '/^$/d' >> "$GITHUB_ENV"
          else
            echo "config/openwrt-sdk.conf not found" >&2
            exit 1
          fi

      - name: Install build dependencies and makeself
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential libncurses5-dev gawk gettext unzip file \
            libssl-dev wget python3 git ca-certificates makeself zstd

      - name: Build PassWall IPK with OpenWrt SDK
        run: |
          set -e
          mkdir -p openwrt-sdk
          cd openwrt-sdk
          echo "Downloading OpenWrt SDK from: $OPENWRT_SDK_URL"
          
          # Determine file extension from URL
          SDK_FILE=$(basename "$OPENWRT_SDK_URL")
          wget "$OPENWRT_SDK_URL" -O "$SDK_FILE"
          
          # Extract based on file extension
          if [[ "$SDK_FILE" == *.tar.zst ]]; then
            tar --use-compress-program=zstd -xf "$SDK_FILE" --strip-components=1
          elif [[ "$SDK_FILE" == *.tar.xz ]]; then
            tar xf "$SDK_FILE" --strip-components=1
          else
            echo "Unsupported SDK archive format: $SDK_FILE" >&2
            exit 1
          fi

          # Initialize feeds configuration from default
          if [ -f feeds.conf.default ]; then
            cp feeds.conf.default feeds.conf
          else
            echo "Warning: feeds.conf.default not found, feeds may not initialize correctly" >&2
          fi

          # Update only the feeds we need (exclude telephony to avoid package collection errors)
          ./scripts/feeds update packages luci routing base
          ./scripts/feeds install -a -p packages
          ./scripts/feeds install -a -p luci
          ./scripts/feeds install -a -p routing
          ./scripts/feeds install -a -p base

          rm -rf feeds/packages/net/{xray-core,v2ray-geodata,sing-box,chinadns-ng,dns2socks,hysteria,ipt2socks,microsocks,naiveproxy,shadowsocks-libev,shadowsocks-rust,shadowsocksr-libev,simple-obfs,tcping,trojan-plus,tuic-client,v2ray-plugin,xray-plugin,geoview,shadow-tls}
          git clone https://github.com/Openwrt-Passwall/openwrt-passwall-packages package/passwall-packages

          rm -rf feeds/luci/applications/luci-app-passwall
          git clone https://github.com/Openwrt-Passwall/openwrt-passwall package/passwall-luci

          ./scripts/feeds update passwall-luci passwall-packages
          ./scripts/feeds install luci-app-passwall

          make defconfig
          make package/luci-app-passwall/compile -j"$(nproc)"

          # Create target directories
          mkdir -p "$GITHUB_WORKSPACE/payload" "$GITHUB_WORKSPACE/payload/depends"

          # Copy compiled packages directly from bin/packages
          # This works regardless of architecture or feed directory structure
          find bin/packages -name "luci-app-passwall_*.ipk" -exec cp {} "$GITHUB_WORKSPACE/payload/" \;
          find bin/packages -name "luci-i18n-passwall-zh-cn_*.ipk" -exec cp {} "$GITHUB_WORKSPACE/payload/" \;

          # 只拷贝与官方安装包一致的一组依赖 IPK
          # 精确白名单（使用前缀匹配，允许版本号变化）：
          #   chinadns-ng, dns2socks, geoview, hysteria, ipt2socks, microsocks, naiveproxy,
          #   shadow-tls, shadowsocks-libev-ss-*, shadowsocks-rust-ss*, shadowsocksr-libev-ssr-*,
          #   simple-obfs-client, sing-box, tcping, trojan-plus, tuic-client,
          #   v2ray-geoip, v2ray-geosite, v2ray-plugin, xray-core, xray-plugin
          find bin/packages -type f \( \
              -name 'chinadns-ng_*.ipk' \
           -o -name 'dns2socks_*.ipk' \
           -o -name 'geoview_*.ipk' \
           -o -name 'hysteria_*.ipk' \
           -o -name 'ipt2socks_*.ipk' \
           -o -name 'microsocks_*.ipk' \
           -o -name 'naiveproxy_*.ipk' \
           -o -name 'shadow-tls_*.ipk' \
           -o -name 'shadowsocks-libev-ss-local_*.ipk' \
           -o -name 'shadowsocks-libev-ss-redir_*.ipk' \
           -o -name 'shadowsocks-libev-ss-server_*.ipk' \
           -o -name 'shadowsocks-rust-sslocal_*.ipk' \
           -o -name 'shadowsocks-rust-ssserver_*.ipk' \
           -o -name 'shadowsocksr-libev-ssr-local_*.ipk' \
           -o -name 'shadowsocksr-libev-ssr-redir_*.ipk' \
           -o -name 'shadowsocksr-libev-ssr-server_*.ipk' \
           -o -name 'simple-obfs-client_*.ipk' \
           -o -name 'sing-box_*.ipk' \
           -o -name 'tcping_*.ipk' \
           -o -name 'trojan-plus_*.ipk' \
           -o -name 'tuic-client_*.ipk' \
           -o -name 'v2ray-geoip_*.ipk' \
           -o -name 'v2ray-geosite_*.ipk' \
           -o -name 'v2ray-plugin_*.ipk' \
           -o -name 'xray-core_*.ipk' \
           -o -name 'xray-plugin_*.ipk' \
          \) -exec cp {} "$GITHUB_WORKSPACE/payload/depends/" \;

          # 如果没有找到任何依赖，直接报错退出，避免生成只有主包没有依赖的安装器
          DEP_COUNT=$(find "$GITHUB_WORKSPACE/payload/depends/" -name "*.ipk" | wc -l)
          if [ "$DEP_COUNT" -eq 0 ]; then
            echo "Error: no dependency IPK files were found and copied into payload/depends" >&2
            exit 1
          fi

          echo "Packages copied successfully:"
          ls -lh "$GITHUB_WORKSPACE/payload/"
          echo "Dependencies count: $(find "$GITHUB_WORKSPACE/payload/depends/" -name "*.ipk" | wc -l)"
          echo "First 20 dependencies:"
          ls -lh "$GITHUB_WORKSPACE/payload/depends/" | head -20

      - name: Validate payload
        run: |
          ls -l payload
          test -f payload/install.sh
          test -f payload/luci-app-passwall_*.ipk
          test -f payload/luci-i18n-passwall-zh-cn_*.ipk
          test -d payload/depends

      - name: Prepare payload
        run: |
          mkdir -p build/payload
          cp -r payload/* build/payload/
          chmod +x build/payload/install.sh

      - name: Build self-extracting installer
        run: |
          cd build
          # 从 luci-app-passwall_*.ipk 文件名中抽取版本号，例如：
          # luci-app-passwall_26.1.25-r1_all.ipk -> 26.1.25
          PW_FULL=$(ls payload | grep 'luci-app-passwall_' | head -n1 | awk -F'[_]' '{print $2}')
          PW_VER=${PW_FULL%%-*}
          # 从 OPENWRT_SDK_URL 提取架构与 SDK 版本
          ARCH_SEG=$(echo "$OPENWRT_SDK_URL" | sed -n 's#.*/targets/\([^/]\+/[^/]\+\)/.*#\1#p')
          if [ -z "$ARCH_SEG" ]; then
            ARCH="unknown"
          else
            ARCH=$(echo "$ARCH_SEG" | tr '/' '_')
          fi

          SDK_VERSION=$(echo "$OPENWRT_SDK_URL" | sed -n 's#.*/openwrt-sdk-\([0-9.]\+\)-.*#\1#p')
          if [ -z "$SDK_VERSION" ]; then
            SDK_VERSION="unknown"
          fi

          RUN_NAME="passwall_${PW_VER}_${ARCH}_sdk_${SDK_VERSION}.run"
          LABEL="passwall_${PW_VER}_with_sdk_${SDK_VERSION}"
          echo "RUN_NAME=${RUN_NAME}" >> $GITHUB_ENV
          echo "LABEL=${LABEL}" >> $GITHUB_ENV
          makeself --nox11 \
            payload \
            "../${RUN_NAME}" \
            "${LABEL}" \
            ./install.sh

      - name: Verify installer
        run: |
          file "${RUN_NAME}"
          sh "${RUN_NAME}" --info
          sh "${RUN_NAME}" --check

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.RUN_NAME }}
          path: ${{ env.RUN_NAME }}

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          files: |
            ${{ env.RUN_NAME }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
