name: Build PassWall Installer

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-installer:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Load OpenWrt SDK config
        run: |
          if [ -f config/openwrt-sdk.conf ]; then
            echo "Using config/openwrt-sdk.conf as OpenWrt SDK config"
            # 文件内容为 KEY=VALUE 形式，直接写入 GITHUB_ENV 供后续步骤使用
            cat config/openwrt-sdk.conf | grep -v '^#' | sed '/^$/d' >> "$GITHUB_ENV"
          else
            echo "config/openwrt-sdk.conf not found" >&2
            exit 1
          fi

      - name: Install build dependencies and makeself
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential libncurses5-dev gawk gettext unzip file \
            libssl-dev wget python3 git ca-certificates makeself zstd

      - name: Download and extract OpenWrt SDK
        env:
          TERM: dumb
        run: |
          set -e
          echo "=========================================="
          echo "Downloading OpenWrt SDK"
          echo "=========================================="
          mkdir -p openwrt-sdk
          cd openwrt-sdk
          echo "SDK URL: $OPENWRT_SDK_URL"
          
          SDK_FILE=$(basename "$OPENWRT_SDK_URL")
          echo "SDK File: $SDK_FILE"
          wget "$OPENWRT_SDK_URL" -O "$SDK_FILE"
          
          echo "Extracting SDK..."
          if [[ "$SDK_FILE" == *.tar.zst ]]; then
            tar --use-compress-program=zstd -xf "$SDK_FILE" --strip-components=1
          elif [[ "$SDK_FILE" == *.tar.xz ]]; then
            tar xf "$SDK_FILE" --strip-components=1
          else
            echo "[ERROR] Unsupported SDK archive format: $SDK_FILE" >&2
            exit 1
          fi
          echo "[SUCCESS] SDK extracted successfully"

      - name: Configure feeds and PassWall sources
        working-directory: openwrt-sdk
        run: |
          set -e
          echo "=========================================="
          echo "Configuring feeds"
          echo "=========================================="
          if [ -f feeds.conf.default ]; then
            cp feeds.conf.default feeds.conf
            echo "[SUCCESS] Copied feeds.conf.default to feeds.conf"
          else
            echo "[WARNING] feeds.conf.default not found" >&2
          fi
          
          # Add OpenWrt community packages master branch for latest Go/Rust toolchains
          # This provides newer versions than the release-based feeds
          echo "" >> feeds.conf
          echo "# OpenWrt community packages master branch for latest language toolchains" >> feeds.conf
          echo "src-git packages_master https://github.com/openwrt/packages.git;master" >> feeds.conf
          echo "[SUCCESS] Added packages_master feed for latest Go/Rust toolchains"
          echo "Current feeds.conf:"
          cat feeds.conf
          
          # Function to update feeds with retry logic
          update_feeds_with_retry() {
            local max_retries=3
            local retry_delay=30
            
            for attempt in $(seq 1 $max_retries); do
              echo "[Attempt $attempt/$max_retries] Updating feeds..."
              if ./scripts/feeds update -a; then
                echo "[SUCCESS] Feeds updated successfully"
                return 0
              else
                echo "[WARNING] Feeds update failed on attempt $attempt"
                if [ $attempt -lt $max_retries ]; then
                  echo "Waiting ${retry_delay}s before retry..."
                  sleep $retry_delay
                  retry_delay=$((retry_delay * 2))
                fi
              fi
            done
            
            echo "[ERROR] All retry attempts failed, trying GitHub mirrors..."
            
            # Replace git.openwrt.org URLs with GitHub mirror URLs in feeds.conf
            if [ -f feeds.conf ]; then
              echo "[INFO] Switching to GitHub mirrors..."
              sed -i \
                -e 's|https://git.openwrt.org/openwrt/openwrt.git|https://github.com/openwrt/openwrt.git|g' \
                -e 's|https://git.openwrt.org/feed/packages.git|https://github.com/openwrt/packages.git|g' \
                -e 's|https://git.openwrt.org/project/luci.git|https://github.com/openwrt/luci.git|g' \
                -e 's|https://git.openwrt.org/feed/routing.git|https://github.com/openwrt/routing.git|g' \
                -e 's|https://git.openwrt.org/feed/telephony.git|https://github.com/openwrt/telephony.git|g' \
                feeds.conf
              
              echo "[INFO] Updated feeds.conf with GitHub mirrors:"
              cat feeds.conf
              echo ""
              
              echo "[INFO] Retrying with GitHub mirrors..."
              if ./scripts/feeds update -a; then
                echo "[SUCCESS] Feeds updated successfully using GitHub mirrors"
                return 0
              fi
            fi
            
            echo "[ERROR] Failed to update feeds even with GitHub mirrors"
            return 1
          }
          
          echo "Updating base feeds..."
          update_feeds_with_retry
          
          echo ""
          echo "=========================================="
          echo "Setting up PassWall sources"
          echo "=========================================="
          rm -rf feeds/packages/net/{xray-core,v2ray-geodata,sing-box,chinadns-ng,dns2socks,hysteria,ipt2socks,microsocks,naiveproxy,shadowsocks-libev,shadowsocks-rust,shadowsocksr-libev,simple-obfs,tcping,trojan-plus,tuic-client,v2ray-plugin,xray-plugin,geoview,shadow-tls}
          
          echo "Cloning openwrt-passwall-packages..."
          git clone --depth=1 https://github.com/Openwrt-Passwall/openwrt-passwall-packages package/passwall-packages
          
          rm -rf feeds/luci/applications/luci-app-passwall
          echo "Cloning openwrt-passwall (luci)..."
          git clone --depth=1 https://github.com/Openwrt-Passwall/openwrt-passwall package/passwall-luci
          
          if [ -n "${PASSWALL_LUCI_REF:-}" ]; then
            echo "Checking out PASSWALL_LUCI_REF: $PASSWALL_LUCI_REF"
            git -C package/passwall-luci fetch --all --tags
            git -C package/passwall-luci checkout "$PASSWALL_LUCI_REF"
          fi
          echo "[SUCCESS] PassWall sources configured"

      - name: Install build dependencies
        working-directory: openwrt-sdk
        run: |
          set -e
          echo "=========================================="
          echo "Installing build dependencies"
          echo "=========================================="
          ./scripts/feeds update -i
          
          echo "Installing language toolchains from packages_master (latest versions)..."
          # Use packages_master feed for latest Go/Rust toolchains
          # The -p option specifies which feed to install from
          ./scripts/feeds install -p packages_master golang rust
          
          echo "Verifying installed toolchain versions..."
          if [ -d "feeds/packages_master/lang/golang" ]; then
            echo "Go version from packages_master:"
            grep -h "PKG_VERSION\|GO_VERSION_MAJOR_MINOR" feeds/packages_master/lang/golang/golang/Makefile 2>/dev/null | head -5 || true
          fi
          if [ -d "feeds/packages_master/lang/rust" ]; then
            echo "Rust version from packages_master:"
            grep -h "PKG_VERSION" feeds/packages_master/lang/rust/rust/Makefile 2>/dev/null | head -3 || true
          fi
          
          echo "Installing runtime dependencies..."
          ./scripts/feeds install \
            libev libmbedtls libsodium libopenssl libpcre2 libudns \
            boost boost-program_options boost-system \
            ca-bundle c-ares pcre2 zlib libubox libubus \
            rpcd rpcd-mod-file rpcd-mod-ucode ucode ucode-mod-fs ucode-mod-uci \
            ucode-mod-ubus ucode-mod-math libucode \
            coreutils coreutils-base64 coreutils-nohup curl dnsmasq-full ip-full \
            libuci-lua luci-compat luci-lib-jsonc resolveip luci-lua-runtime \
            iwinfo openssl libnl-tiny
          
          echo "Installing LuCI base..."
          ./scripts/feeds install luci-base
          
          echo "Installing luci-app-passwall..."
          ./scripts/feeds install luci-app-passwall
          echo "[SUCCESS] Dependencies installed"

      - name: Configure build options
        working-directory: openwrt-sdk
        run: |
          set -e
          echo "=========================================="
          echo "Configuring build options"
          echo "=========================================="
          echo "Running defconfig..."
          yes '' | make defconfig
          
          echo "Enabling PassWall packages in config..."
          cat >> .config << 'EOF'
          CONFIG_PACKAGE_chinadns-ng=m
          CONFIG_PACKAGE_dns2socks=m
          CONFIG_PACKAGE_geoview=m
          CONFIG_PACKAGE_hysteria=m
          CONFIG_PACKAGE_ipt2socks=m
          CONFIG_PACKAGE_microsocks=m
          CONFIG_PACKAGE_naiveproxy=m
          CONFIG_PACKAGE_shadow-tls=m
          CONFIG_PACKAGE_shadowsocks-rust-sslocal=m
          CONFIG_PACKAGE_shadowsocks-rust-ssserver=m
          CONFIG_PACKAGE_shadowsocksr-libev-ssr-local=m
          CONFIG_PACKAGE_shadowsocksr-libev-ssr-redir=m
          CONFIG_PACKAGE_shadowsocksr-libev-ssr-server=m
          CONFIG_PACKAGE_simple-obfs-client=m
          CONFIG_PACKAGE_sing-box=m
          CONFIG_PACKAGE_tcping=m
          CONFIG_PACKAGE_trojan-plus=m
          CONFIG_PACKAGE_tuic-client=m
          CONFIG_PACKAGE_v2ray-geoip=m
          CONFIG_PACKAGE_v2ray-geosite=m
          CONFIG_PACKAGE_v2ray-plugin=m
          CONFIG_PACKAGE_xray-core=m
          CONFIG_PACKAGE_xray-plugin=m
          EOF
          yes '' | make defconfig
          echo "[SUCCESS] Build configured"

      - name: Compile host tools
        working-directory: openwrt-sdk
        run: |
          set -e
          echo "=========================================="
          echo "Compiling luci-base host tools"
          echo "=========================================="
          make package/feeds/luci/luci-base/host/compile V=s
          echo "[SUCCESS] Host tools compiled"

      - name: Compile luci-app-passwall
        working-directory: openwrt-sdk
        run: |
          set -e
          echo "=========================================="
          echo "Compiling luci-app-passwall"
          echo "=========================================="
          make package/luci-app-passwall/compile -j"$(nproc)" V=s || {
            echo "[WARNING] Parallel build failed, retrying with single thread"
            make package/luci-app-passwall/compile V=s
          }
          echo "[SUCCESS] luci-app-passwall compiled"

      - name: Compile dependency packages
        working-directory: openwrt-sdk
        run: |
          set -e
          echo "=========================================="
          echo "Building PassWall dependency packages"
          echo "=========================================="
          
          PASSWALL_DEPS="chinadns-ng dns2socks geoview hysteria ipt2socks microsocks naiveproxy \
            shadow-tls shadowsocks-libev shadowsocks-rust shadowsocksr-libev simple-obfs sing-box tcping \
            trojan-plus tuic-client v2ray-geodata v2ray-plugin xray-core xray-plugin"
          
          for pkg in $PASSWALL_DEPS; do
            echo ""
            echo "--- Building: $pkg ---"
            PKG_PATH=""
            if [ -d "package/passwall-packages/$pkg" ]; then
              PKG_PATH="package/passwall-packages/$pkg"
            elif [ -d "package/$pkg" ]; then
              PKG_PATH="package/$pkg"
            fi
            
            if [ -n "$PKG_PATH" ]; then
              make "$PKG_PATH/compile" -j"$(nproc)" V=s 2>&1 || {
                echo "[WARNING] Failed to compile $pkg (parallel), trying single thread"
                make "$PKG_PATH/compile" V=s 2>&1 || {
                  echo "[WARNING] Failed to compile $pkg, will use prebuilt if available"
                }
              }
            else
              echo "[WARNING] Package $pkg not found in expected locations"
            fi
          done
          
          echo ""
          echo "--- Building: luci-i18n-passwall-zh-cn ---"
          make package/luci-i18n-passwall-zh-cn/compile -j"$(nproc)" || true
          
          echo "[SUCCESS] Dependency package compilation completed"

      - name: Download prebuilt packages
        run: |
          set -e
          echo "=========================================="
          echo "Detecting target architecture"
          echo "=========================================="
          TARGET_ARCH=$(echo "$OPENWRT_SDK_URL" | sed -n 's#.*/targets/\([^/]\+\)/\([^/]\+\)/.*#\1#p')
          TARGET_SUBTARGET=$(echo "$OPENWRT_SDK_URL" | sed -n 's#.*/targets/\([^/]\+\)/\([^/]\+\)/.*#\2#p')
          
          if [ "$TARGET_ARCH" = "x86" ] && [ "$TARGET_SUBTARGET" = "64" ]; then
            ARCH_NAME="x86_64"
          elif [ "$TARGET_ARCH" = "x86" ] && [ "$TARGET_SUBTARGET" = "generic" ]; then
            ARCH_NAME="x86_64"
          elif [ "$TARGET_ARCH" = "ramips" ] && [ "$TARGET_SUBTARGET" = "mt7621" ]; then
            ARCH_NAME="mipsel_24kc"
          elif [ "$TARGET_ARCH" = "ramips" ] && [ "$TARGET_SUBTARGET" = "mt7620" ]; then
            ARCH_NAME="mipsel_24kc"
          elif [ "$TARGET_ARCH" = "ath79" ] && [ "$TARGET_SUBTARGET" = "generic" ]; then
            ARCH_NAME="mips_24kc"
          elif [ "$TARGET_ARCH" = "bcm27xx" ] || [ "$TARGET_ARCH" = "bcm2708" ]; then
            ARCH_NAME="arm_cortex-a7"
          elif [ "$TARGET_ARCH" = "ipq40xx" ]; then
            ARCH_NAME="arm_cortex-a7_neon-vfpv4"
          else
            echo "[WARNING] Unknown architecture ${TARGET_ARCH}/${TARGET_SUBTARGET}, using x86_64 as fallback"
            ARCH_NAME="x86_64"
          fi
          
          echo "SDK URL: $OPENWRT_SDK_URL"
          echo "Target: ${TARGET_ARCH}/${TARGET_SUBTARGET}"
          echo "Package architecture: $ARCH_NAME"
          echo "ARCH_NAME=$ARCH_NAME" >> $GITHUB_ENV
          
          # Detect SDK version from URL (with patch version, e.g., 24.10.5)
          SDK_VERSION_FULL=$(echo "$OPENWRT_SDK_URL" | sed -n 's#.*/openwrt-sdk-\([0-9]\+\.[0-9]\+\.[0-9]\+\).*#\1#p')
          SDK_VERSION=$(echo "$OPENWRT_SDK_URL" | sed -n 's#.*/openwrt-sdk-\([0-9]\+\.[0-9]\+\).*#\1#p')
          if [ -z "$SDK_VERSION" ]; then
            SDK_VERSION="24.10"
          fi
          if [ -z "$SDK_VERSION_FULL" ]; then
            SDK_VERSION_FULL="$SDK_VERSION"
          fi
          echo "SDK Version: $SDK_VERSION (Full: $SDK_VERSION_FULL)"
          
          echo ""
          echo "=========================================="
          echo "Downloading PassWall dependency packages from OpenWrt official sources"
          echo "=========================================="
          
          mkdir -p prebuilt-packages
          cd prebuilt-packages
          
          PREBUILT_DOWNLOADED=false
          
          # PassWall dependency packages - download from OpenWrt official sources
          # These are the dependency packages that PassWall needs (not the luci-app-passwall itself)
          # Note: Go/Rust toolchains are now installed from OpenWrt packages master branch,
          # which should provide newer versions. However, some packages may still fail to compile
          # due to other CI environment limitations. Prebuilt packages are used as fallback.
          # Note: shadowsocks-libev and shadowsocksr-libev variants are compiled from SDK, not downloaded
          PASSWALL_DEPS="chinadns-ng dns2socks geoview hysteria ipt2socks microsocks naiveproxy \
            shadow-tls shadowsocks-rust-sslocal shadowsocks-rust-ssserver \
            simple-obfs sing-box tcping trojan-plus tuic-client \
            v2ray-geoip v2ray-geosite v2ray-plugin xray-core xray-plugin"
          
          # Try official OpenWrt releases for PassWall dependency packages
          OPENWRT_SUBDIRS="packages base"
          
          for SUBDIR in $OPENWRT_SUBDIRS; do
            OPENWRT_INDEX="https://downloads.openwrt.org/releases/${SDK_VERSION_FULL}/packages/${ARCH_NAME}/${SUBDIR}/Packages"
            
            echo "Trying OpenWrt official index: $OPENWRT_INDEX"
            if wget -q --timeout=60 -O "Packages-openwrt-${SUBDIR}.tmp" "$OPENWRT_INDEX" 2>/dev/null; then
              if [ -s "Packages-openwrt-${SUBDIR}.tmp" ] && grep -q "^Package:" "Packages-openwrt-${SUBDIR}.tmp" 2>/dev/null; then
                mv "Packages-openwrt-${SUBDIR}.tmp" "Packages-openwrt-${SUBDIR}"
                echo "[SUCCESS] Downloaded OpenWrt ${SDK_VERSION_FULL} ${SUBDIR} package index"
                echo "[INFO] Index contains $(grep -c '^Package:' Packages-openwrt-${SUBDIR}) packages"
                
                for pkg in $PASSWALL_DEPS; do
                  # Skip if already downloaded
                  if ls "${pkg}_"*.ipk >/dev/null 2>&1; then
                    continue
                  fi
                  
                  # Extract filename from Packages index
                  PKG_FILE=$(grep -A 10 "^Package: ${pkg}$" Packages-openwrt-${SUBDIR} | grep "^Filename:" | head -1 | awk '{print $2}')
                  if [ -n "$PKG_FILE" ]; then
                    PKG_URL="https://downloads.openwrt.org/releases/${SDK_VERSION_FULL}/packages/${ARCH_NAME}/${SUBDIR}/${PKG_FILE}"
                    echo "Downloading PassWall dependency from OpenWrt official: $pkg"
                    if wget -q --timeout=60 -O "$(basename "$PKG_FILE")" "$PKG_URL" 2>/dev/null && [ -s "$(basename "$PKG_FILE")" ]; then
                      echo "  [SUCCESS] Downloaded $pkg from OpenWrt official"
                      PREBUILT_DOWNLOADED=true
                    else
                      echo "  [FAILED] Could not download $pkg from OpenWrt official"
                    fi
                  fi
                done
                
                rm -f Packages-openwrt-${SUBDIR}
              else
                echo "[INFO] Response is not a valid Packages index"
                rm -f "Packages-openwrt-${SUBDIR}.tmp"
              fi
            else
              echo "[INFO] Could not reach OpenWrt ${SDK_VERSION_FULL} ${SUBDIR} index"
            fi
          done
          
          echo ""
          echo "=========================================="
          echo "Downloading missing PassWall dependencies from SourceForge (fallback)"
          echo "=========================================="
          
          # Check which packages are still missing after trying OpenWrt official
          MISSING_DEPS=""
          for pkg in $PASSWALL_DEPS; do
            if ! ls "${pkg}_"*.ipk >/dev/null 2>&1; then
              MISSING_DEPS="$MISSING_DEPS $pkg"
            fi
          done
          
          if [ -n "$MISSING_DEPS" ]; then
            echo "[INFO] Missing dependency packages after OpenWrt official:$MISSING_DEPS"
          else
            echo "[SUCCESS] All PassWall dependency packages downloaded from OpenWrt official"
          fi
          
          # SourceForge mirror URLs for openwrt-passwall-build (fallback for missing deps)
          SF_MIRRORS="master.dl.sourceforge.net downloads.sourceforge.net netcologne.dl.sourceforge.net netix.dl.sourceforge.net"
          
          # Try SourceForge passwall-build repository for missing dependency packages
          if [ -n "$MISSING_DEPS" ]; then
            for SF_MIRROR in $SF_MIRRORS; do
              SOURCEFORGE_INDEX="https://${SF_MIRROR}/project/openwrt-passwall-build/releases/packages-${SDK_VERSION}/${ARCH_NAME}/passwall_packages/Packages"
              
              echo "Trying SourceForge package index for missing deps: $SOURCEFORGE_INDEX"
              if wget -q --timeout=60 -O "Packages.tmp" "$SOURCEFORGE_INDEX" 2>/dev/null; then
                # Check if the downloaded file is an actual Packages index (not HTML error page)
                if [ -s "Packages.tmp" ] && grep -q "^Package:" "Packages.tmp" 2>/dev/null; then
                  mv "Packages.tmp" "Packages"
                  echo "[SUCCESS] Downloaded package index from SourceForge ($SF_MIRROR)"
                  echo "[INFO] Packages index contains $(grep -c '^Package:' Packages) packages"
                  
                  for pkg in $MISSING_DEPS; do
                    # Skip if already downloaded
                    if ls "${pkg}_"*.ipk >/dev/null 2>&1; then
                      continue
                    fi
                    # Extract filename from Packages index
                    PKG_FILE=$(grep -A 10 "^Package: ${pkg}$" Packages | grep "^Filename:" | head -1 | awk '{print $2}')
                    if [ -n "$PKG_FILE" ]; then
                      PKG_URL="https://${SF_MIRROR}/project/openwrt-passwall-build/releases/packages-${SDK_VERSION}/${ARCH_NAME}/passwall_packages/${PKG_FILE}"
                      echo "Downloading missing dependency from SourceForge: $pkg"
                      if wget -q --timeout=60 -O "$(basename "$PKG_FILE")" "$PKG_URL" 2>/dev/null && [ -s "$(basename "$PKG_FILE")" ]; then
                        echo "  [SUCCESS] Downloaded $pkg"
                        PREBUILT_DOWNLOADED=true
                      else
                        echo "  [SKIPPED] Could not download $pkg from $SF_MIRROR"
                      fi
                    else
                      echo "  [INFO] Package $pkg not found in index"
                    fi
                  done
                  
                  # Check if we still have missing packages
                  STILL_MISSING=""
                  for pkg in $MISSING_DEPS; do
                    if ! ls "${pkg}_"*.ipk >/dev/null 2>&1; then
                      STILL_MISSING="$STILL_MISSING $pkg"
                    fi
                  done
                  
                  # If we got all packages, stop trying mirrors
                  if [ -z "$STILL_MISSING" ]; then
                    break
                  fi
                else
                  echo "[INFO] Response from $SF_MIRROR is not a valid Packages index"
                  rm -f "Packages.tmp"
                fi
              else
                echo "[INFO] Could not reach $SF_MIRROR"
              fi
            done
          fi
          
          # Fallback 1: Try packages-25.12 for missing Rust packages (shadow-tls, shadowsocks-rust)
          # These packages are often available in newer SDK versions even when not in older ones
          RUST_PACKAGES="shadow-tls shadowsocks-rust-sslocal shadowsocks-rust-ssserver"
          RUST_MISSING=""
          for pkg in $RUST_PACKAGES; do
            if ! ls "${pkg}_"*.ipk >/dev/null 2>&1; then
              RUST_MISSING="$RUST_MISSING $pkg"
            fi
          done
          
          if [ -n "$RUST_MISSING" ]; then
            echo ""
            echo "=========================================="
            echo "Trying packages-25.12 for Rust packages:$RUST_MISSING"
            echo "=========================================="
            
            for SF_MIRROR in $SF_MIRRORS; do
              SOURCEFORGE_INDEX_25="https://${SF_MIRROR}/project/openwrt-passwall-build/releases/packages-25.12/${ARCH_NAME}/passwall_packages/Packages"
              
              echo "Trying SourceForge packages-25.12 index: $SOURCEFORGE_INDEX_25"
              if wget -q --timeout=60 -O "Packages-25.tmp" "$SOURCEFORGE_INDEX_25" 2>/dev/null; then
                if [ -s "Packages-25.tmp" ] && grep -q "^Package:" "Packages-25.tmp" 2>/dev/null; then
                  mv "Packages-25.tmp" "Packages-25"
                  echo "[SUCCESS] Downloaded packages-25.12 index from SourceForge ($SF_MIRROR)"
                  echo "[INFO] Packages-25.12 index contains $(grep -c '^Package:' Packages-25) packages"
                  
                  for pkg in $RUST_MISSING; do
                    # Skip if already downloaded
                    if ls "${pkg}_"*.ipk >/dev/null 2>&1; then
                      continue
                    fi
                    
                    # Extract filename from Packages index
                    PKG_FILE=$(grep -A 10 "^Package: ${pkg}$" Packages-25 | grep "^Filename:" | head -1 | awk '{print $2}')
                    if [ -n "$PKG_FILE" ]; then
                      PKG_URL="https://${SF_MIRROR}/project/openwrt-passwall-build/releases/packages-25.12/${ARCH_NAME}/passwall_packages/${PKG_FILE}"
                      echo "Downloading from packages-25.12: $pkg"
                      if wget -q --timeout=60 -O "$(basename "$PKG_FILE")" "$PKG_URL" 2>/dev/null && [ -s "$(basename "$PKG_FILE")" ]; then
                        echo "  [SUCCESS] Downloaded $pkg from packages-25.12"
                        PREBUILT_DOWNLOADED=true
                      else
                        echo "  [FAILED] Could not download $pkg from packages-25.12"
                      fi
                    else
                      echo "  [INFO] Package $pkg not found in packages-25.12 index"
                    fi
                  done
                  
                  rm -f Packages-25
                  break
                else
                  echo "[INFO] Response from $SF_MIRROR for packages-25.12 is not a valid Packages index"
                  rm -f "Packages-25.tmp"
                fi
              else
                echo "[INFO] Could not reach $SF_MIRROR for packages-25.12"
              fi
            done
          fi
          
          # Fallback 2: Try openwrt-passwall.mirror SourceForge for missing PassWall dependency packages
          # This project contains complete package archives organized by release version
          STILL_MISSING=""
          for pkg in $PASSWALL_DEPS; do
            if ! ls "${pkg}_"*.ipk >/dev/null 2>&1; then
              STILL_MISSING="$STILL_MISSING $pkg"
            fi
          done
          
          if [ -n "$STILL_MISSING" ]; then
            echo ""
            echo "=========================================="
            echo "Trying openwrt-passwall.mirror for missing dependency packages:$STILL_MISSING"
            echo "=========================================="
            
            # Try to get the latest release version from openwrt-passwall.mirror
            # The releases are organized as folders like 26.1.17-1, 25.12.25-1, etc.
            # Updated list based on actual available releases on SourceForge
            RELEASE_VERSIONS="26.1.17-1 25.12.25-1 26.1.1-1 25.12.22-1 25.12.15-1"
            
            for SF_MIRROR in $SF_MIRRORS; do
              echo "Checking openwrt-passwall.mirror on $SF_MIRROR..."
              
              for RELEASE_VER in $RELEASE_VERSIONS; do
                # Try to download the complete packages zip for the architecture
                ZIP_URL="https://${SF_MIRROR}/project/openwrt-passwall.mirror/${RELEASE_VER}/passwall_packages_ipk_${ARCH_NAME}.zip"
                
                echo "  Trying: $ZIP_URL"
                # Download with timeout and capture exit status properly
                wget --timeout=120 -O "packages.zip" "$ZIP_URL" 2>&1 | head -10 || true
                
                if [ -s "packages.zip" ] && file packages.zip | grep -q "Zip archive"; then
                  echo "  [SUCCESS] Downloaded package archive from release $RELEASE_VER"
                  
                  # Extract only the missing packages
                  mkdir -p temp_extract
                  if unzip -q -o packages.zip -d temp_extract 2>/dev/null; then
                    echo "  Extracting missing packages..."
                    for pkg in $STILL_MISSING; do
                      # Skip if already downloaded
                      if ls "${pkg}_"*.ipk >/dev/null 2>&1; then
                        continue
                      fi
                      PKG_FILE=$(find temp_extract -name "${pkg}_*.ipk" 2>/dev/null | head -1)
                      if [ -n "$PKG_FILE" ] && [ -f "$PKG_FILE" ]; then
                        cp "$PKG_FILE" .
                        echo "    [SUCCESS] Extracted $pkg from archive"
                        PREBUILT_DOWNLOADED=true
                      else
                        echo "    [INFO] Package $pkg not found in archive"
                      fi
                    done
                  else
                    echo "  [ERROR] Failed to extract packages.zip"
                  fi
                  rm -rf temp_extract packages.zip
                  
                  # Check if we got all missing packages
                  ALL_FOUND=true
                  for pkg in $STILL_MISSING; do
                    if ! ls "${pkg}_"*.ipk >/dev/null 2>&1; then
                      ALL_FOUND=false
                      break
                    fi
                  done
                  
                  if [ "$ALL_FOUND" = "true" ]; then
                    echo "  [SUCCESS] All missing packages found in $RELEASE_VER"
                    break 2
                  fi
                else
                  echo "  [INFO] Downloaded file is not a valid zip archive, trying next version..."
                  rm -f packages.zip
                fi
              done
            done
          fi
          
          # Final report on missing PassWall dependency packages
          FINAL_MISSING=""
          for pkg in $PASSWALL_DEPS; do
            if ! ls "${pkg}_"*.ipk >/dev/null 2>&1; then
              FINAL_MISSING="$FINAL_MISSING $pkg"
            fi
          done
          
          if [ -n "$FINAL_MISSING" ]; then
            echo ""
            echo "[WARNING] Still missing dependency packages after all fallbacks:$FINAL_MISSING"
            echo "[INFO] These packages may not be available in any prebuilt repository"
          fi
          
          # Count downloaded packages
          PKG_COUNT=$(find . -name "*.ipk" 2>/dev/null | wc -l)
          echo ""
          echo "Prebuilt packages downloaded: $PKG_COUNT"
          
          if [ "$PKG_COUNT" -gt 0 ]; then
            echo "Downloaded packages:"
            ls -la *.ipk 2>/dev/null || true
          fi
          
          if [ "$PKG_COUNT" -eq 0 ]; then
            echo "[WARNING] No prebuilt packages could be downloaded"
            echo "[INFO] Some packages may fail to compile due to CI environment limitations"
            echo "[INFO] These packages will be missing from the final installer"
          fi
          
          echo "PREBUILT_DOWNLOADED=$PREBUILT_DOWNLOADED" >> $GITHUB_ENV

      - name: Collect and merge packages
        working-directory: openwrt-sdk
        run: |
          set -e
          echo "=========================================="
          echo "Collecting built packages"
          echo "=========================================="
          
          mkdir -p "$GITHUB_WORKSPACE/payload" "$GITHUB_WORKSPACE/payload/depends"
          mkdir -p "$GITHUB_WORKSPACE/built-packages" "$GITHUB_WORKSPACE/prebuilt-staging"
          
          if [ "$PREBUILT_DOWNLOADED" = "true" ]; then
            cp "$GITHUB_WORKSPACE/prebuilt-packages/"*.ipk "$GITHUB_WORKSPACE/prebuilt-staging/" 2>/dev/null || true
            echo "Prebuilt packages available: $(ls -1 "$GITHUB_WORKSPACE/prebuilt-staging/" | wc -l)"
          fi
          
          find bin/packages -name "luci-app-passwall_*.ipk" -exec cp {} "$GITHUB_WORKSPACE/payload/" \;
          find bin/packages -name "luci-i18n-passwall-zh-cn_*.ipk" -exec cp {} "$GITHUB_WORKSPACE/payload/" \;
          
          # PassWall dependency packages (downloaded from OpenWrt official or SourceForge fallback)
          # Note: PASSWALL_DEPS (prebuilt download list) contains packages that may need prebuilt binaries
          # DEPENDENCY_PATTERNS includes additional shadowsocks-libev and shadowsocksr-libev variants
          # that are compiled from SDK source, not downloaded as prebuilt packages
          DEPENDENCY_PATTERNS="chinadns-ng dns2socks geoview hysteria ipt2socks microsocks naiveproxy \
            shadow-tls shadowsocks-libev-ss-local shadowsocks-libev-ss-redir shadowsocks-libev-ss-server \
            shadowsocks-rust-sslocal shadowsocks-rust-ssserver \
            shadowsocksr-libev-ssr-local shadowsocksr-libev-ssr-redir shadowsocksr-libev-ssr-server \
            simple-obfs-client sing-box tcping trojan-plus tuic-client \
            v2ray-geoip v2ray-geosite v2ray-plugin xray-core xray-plugin"
          
          for pkg_name in $DEPENDENCY_PATTERNS; do
            find bin/packages -type f -name "${pkg_name}_*.ipk" -exec cp {} "$GITHUB_WORKSPACE/built-packages/" \;
          done
          
          echo "Built packages found: $(find "$GITHUB_WORKSPACE/built-packages/" -name "*.ipk" 2>/dev/null | wc -l)"
          
          compare_versions() {
            local ver1="$1"
            local ver2="$2"
            local highest=$(printf '%s\n%s\n' "$ver1" "$ver2" | sort -V | tail -n1)
            [ "$ver1" = "$highest" ]
          }
          
          extract_version() {
            local filename="$1"
            filename=$(basename "$filename")
            echo "$filename" | sed 's/^[^_]*_\([^_]*\)_.*/\1/'
          }
          
          echo ""
          echo "=========================================="
          echo "Comparing built vs prebuilt packages"
          echo "=========================================="
          printf "%-35s %-15s %-15s %-10s\n" "Package" "Built Ver" "Prebuilt Ver" "Selected"
          printf "%-35s %-15s %-15s %-10s\n" "-----------------------------------" "---------------" "---------------" "----------"
          
          for pkg_prefix in $DEPENDENCY_PATTERNS; do
            BUILT_PKG=""
            PREBUILT_PKG=""
            BUILT_VER=""
            PREBUILT_VER=""
            SELECTED=""
            SOURCE=""
            
            for f in "$GITHUB_WORKSPACE/built-packages/${pkg_prefix}_"*.ipk; do
              if [ -e "$f" ]; then
                BUILT_PKG="$f"
                BUILT_VER=$(extract_version "$f")
                break
              fi
            done
            
            for f in "$GITHUB_WORKSPACE/prebuilt-staging/${pkg_prefix}_"*.ipk; do
              if [ -e "$f" ]; then
                PREBUILT_PKG="$f"
                PREBUILT_VER=$(extract_version "$f")
                break
              fi
            done
            
            if [ -n "$BUILT_PKG" ] && [ -n "$PREBUILT_PKG" ]; then
              if compare_versions "$BUILT_VER" "$PREBUILT_VER"; then
                SELECTED="$BUILT_PKG"
                SOURCE="BUILT"
              else
                SELECTED="$PREBUILT_PKG"
                SOURCE="PREBUILT"
              fi
              printf "%-35s %-15s %-15s %-10s\n" "$pkg_prefix" "$BUILT_VER" "$PREBUILT_VER" "$SOURCE"
            elif [ -n "$BUILT_PKG" ]; then
              SELECTED="$BUILT_PKG"
              SOURCE="BUILT"
              printf "%-35s %-15s %-15s %-10s\n" "$pkg_prefix" "$BUILT_VER" "(none)" "$SOURCE"
            elif [ -n "$PREBUILT_PKG" ]; then
              SELECTED="$PREBUILT_PKG"
              SOURCE="PREBUILT"
              printf "%-35s %-15s %-15s %-10s\n" "$pkg_prefix" "(none)" "$PREBUILT_VER" "$SOURCE"
            else
              printf "%-35s %-15s %-15s %-10s\n" "$pkg_prefix" "(none)" "(none)" "MISSING"
              continue
            fi
            
            if [ -n "$SELECTED" ]; then
              cp "$SELECTED" "$GITHUB_WORKSPACE/payload/depends/"
            fi
          done
          
          echo ""
          echo "=========================================="
          echo "Package Collection Summary"
          echo "=========================================="
          MISSING_PKGS=""
          for pkg_prefix in $DEPENDENCY_PATTERNS; do
            if ! ls "$GITHUB_WORKSPACE/payload/depends/${pkg_prefix}_"*.ipk 1>/dev/null 2>&1; then
              MISSING_PKGS="$MISSING_PKGS $pkg_prefix"
            fi
          done
          
          if [ -n "$MISSING_PKGS" ]; then
            echo "[WARNING] The following packages are MISSING and will not be in the installer:"
            for pkg in $MISSING_PKGS; do
              echo "  - $pkg"
            done
            echo ""
            echo "[INFO] These packages may have failed to compile or were not available as prebuilt."
            echo "[INFO] Consider downloading prebuilt packages from SourceForge."
          else
            echo "[SUCCESS] All dependency packages collected successfully!"
          fi

      - name: Validate final packages
        run: |
          set -e
          echo "=========================================="
          echo "Validating final packages"
          echo "=========================================="
          
          DEP_COUNT=$(find "$GITHUB_WORKSPACE/payload/depends/" -name "*.ipk" | wc -l)
          
          if [ "$DEP_COUNT" -eq 0 ]; then
            echo "[ERROR] No dependency IPK files found in payload/depends" >&2
            exit 1
          fi
          
          # Package count explanation:
          # DEPENDENCY_PATTERNS lists 23 PassWall dependency package patterns.
          # Go/Rust toolchains are now from OpenWrt packages master branch for latest versions.
          # Some packages may still fail to compile due to CI environment limitations.
          # Dependency packages are downloaded from OpenWrt official first, then SourceForge fallback
          # Minimum expected: 15 packages
          # With all prebuilt packages: up to 23 packages
          MIN_EXPECTED_PACKAGES=15
          if [ "$DEP_COUNT" -lt "$MIN_EXPECTED_PACKAGES" ]; then
            echo "[WARNING] Only $DEP_COUNT dependency packages found (expected $MIN_EXPECTED_PACKAGES-23)"
            echo "[INFO] Some packages may have failed to compile or download"
          fi
          
          echo ""
          echo "Main packages:"
          find "$GITHUB_WORKSPACE/payload/" -maxdepth 1 -name "*.ipk" | xargs -r -n1 basename | sort | sed 's/^/  - /'
          echo ""
          echo "Dependency packages (total: $DEP_COUNT):"
          ls -1 "$GITHUB_WORKSPACE/payload/depends/" | sort | sed 's/^/  - /'
          echo ""
          echo "[SUCCESS] Package validation completed"

      - name: Validate payload
        run: |
          ls -l payload
          test -f payload/install.sh
          test -f payload/luci-app-passwall_*.ipk
          test -f payload/luci-i18n-passwall-zh-cn_*.ipk
          test -d payload/depends

      - name: Prepare payload
        run: |
          mkdir -p build/payload
          cp -r payload/* build/payload/
          chmod +x build/payload/install.sh

      - name: Build self-extracting installer
        run: |
          cd build
          # 从 luci-app-passwall_*.ipk 文件名中抽取版本号，例如：
          # luci-app-passwall_26.1.25-r1_all.ipk -> 26.1.25
          PW_FULL=$(ls payload | grep 'luci-app-passwall_' | head -n1 | awk -F'[_]' '{print $2}')
          PW_VER=${PW_FULL%%-*}
          # 从 OPENWRT_SDK_URL 提取架构与 SDK 版本
          ARCH_SEG=$(echo "$OPENWRT_SDK_URL" | sed -n 's#.*/targets/\([^/]\+/[^/]\+\)/.*#\1#p')
          if [ -z "$ARCH_SEG" ]; then
            ARCH="unknown"
          else
            ARCH=$(echo "$ARCH_SEG" | tr '/' '_')
          fi

          SDK_VERSION=$(echo "$OPENWRT_SDK_URL" | sed -n 's#.*/openwrt-sdk-\([0-9.]\+\)-.*#\1#p')
          if [ -z "$SDK_VERSION" ]; then
            SDK_VERSION="unknown"
          fi

          RUN_NAME="passwall_${PW_VER}_${ARCH}_sdk_${SDK_VERSION}.run"
          LABEL="passwall_${PW_VER}_with_sdk_${SDK_VERSION}"
          echo "RUN_NAME=${RUN_NAME}" >> $GITHUB_ENV
          echo "LABEL=${LABEL}" >> $GITHUB_ENV
          makeself --nox11 \
            payload \
            "../${RUN_NAME}" \
            "${LABEL}" \
            ./install.sh

      - name: Verify installer
        run: |
          file "${RUN_NAME}"
          sh "${RUN_NAME}" --info
          sh "${RUN_NAME}" --check

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.RUN_NAME }}
          path: ${{ env.RUN_NAME }}

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          files: |
            ${{ env.RUN_NAME }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
