name: Build PassWall Installer

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-installer:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Load OpenWrt SDK config
        run: |
          if [ -f config/openwrt-sdk.conf ]; then
            echo "Using config/openwrt-sdk.conf as OpenWrt SDK config"
            # 文件内容为 KEY=VALUE 形式，直接写入 GITHUB_ENV 供后续步骤使用
            cat config/openwrt-sdk.conf | grep -v '^#' | sed '/^$/d' >> "$GITHUB_ENV"
          else
            echo "config/openwrt-sdk.conf not found" >&2
            exit 1
          fi

      - name: Install build dependencies and makeself
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential libncurses5-dev gawk gettext unzip file \
            libssl-dev wget python3 git ca-certificates makeself zstd

      - name: Install Go (latest version)
        run: |
          set -e
          echo "=========================================="
          echo "Installing latest Go for OpenWrt SDK"
          echo "=========================================="
          
          # Download and install the latest stable Go version from official source
          # This will be used by the OpenWrt SDK build system for compiling Go packages
          # Required for xray-core, v2ray-plugin, and other Go-based PassWall dependencies
          # NOTE: We install system Go instead of using golang from feeds because
          # feeds only provide older versions that may not meet the requirements of latest PassWall dependencies
          
          echo "Fetching latest Go version..."
          GO_VERSION=$(curl -s https://go.dev/VERSION?m=text | head -1 | sed 's/go//')
          
          if [ -z "$GO_VERSION" ]; then
            echo "[ERROR] Failed to fetch latest Go version from go.dev"
            echo "[ERROR] Please check your internet connection or go.dev availability"
            exit 1
          fi
          
          echo "Latest Go version: ${GO_VERSION}"
          GO_TARBALL="go${GO_VERSION}.linux-amd64.tar.gz"
          
          echo "Downloading Go ${GO_VERSION}..."
          wget "https://go.dev/dl/${GO_TARBALL}" -O "/tmp/${GO_TARBALL}"
          
          echo "Extracting Go..."
          sudo rm -rf /usr/local/go
          sudo tar -C /usr/local -xzf "/tmp/${GO_TARBALL}"
          
          echo "Setting up Go environment..."
          echo "/usr/local/go/bin" >> $GITHUB_PATH
          
          # Verify installation
          /usr/local/go/bin/go version
          echo "[SUCCESS] Go ${GO_VERSION} installed successfully and added to PATH"

      - name: Install Rust toolchain
        run: |
          set -e
          echo "=========================================="
          echo "Installing Rust toolchain for OpenWrt SDK"
          echo "=========================================="
          
          # Install Rust using rustup (official Rust installer)
          # This will be used by the OpenWrt SDK build system for compiling Rust packages
          # Required for shadow-tls, shadowsocks-rust packages
          # NOTE: We install system Rust instead of building from feeds because:
          # 1. Building Rust compiler from source takes too long in CI (often >30 minutes)
          # 2. It frequently fails with build errors in CI environment
          # 3. System rustup provides stable, pre-built toolchains that work reliably
          # 4. We need to add the x86_64-unknown-linux-musl target for OpenWrt SDK cross-compilation
          
          echo "Installing rustup..."
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable
          
          echo "Setting up Rust environment..."
          source "$HOME/.cargo/env"
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          
          # Add musl target for OpenWrt cross-compilation
          echo "Adding x86_64-unknown-linux-musl target..."
          rustup target add x86_64-unknown-linux-musl
          
          # Verify installation
          rustc --version
          cargo --version
          rustup target list --installed
          echo "[SUCCESS] Rust toolchain installed successfully and added to PATH"

      - name: Download and extract OpenWrt SDK
        env:
          TERM: dumb
        run: |
          set -e
          echo "=========================================="
          echo "Downloading OpenWrt SDK"
          echo "=========================================="
          mkdir -p openwrt-sdk
          cd openwrt-sdk
          echo "SDK URL: $OPENWRT_SDK_URL"
          
          SDK_FILE=$(basename "$OPENWRT_SDK_URL")
          echo "SDK File: $SDK_FILE"
          wget "$OPENWRT_SDK_URL" -O "$SDK_FILE"
          
          echo "Extracting SDK..."
          if [[ "$SDK_FILE" == *.tar.zst ]]; then
            tar --use-compress-program=zstd -xf "$SDK_FILE" --strip-components=1
          elif [[ "$SDK_FILE" == *.tar.xz ]]; then
            tar xf "$SDK_FILE" --strip-components=1
          else
            echo "[ERROR] Unsupported SDK archive format: $SDK_FILE" >&2
            exit 1
          fi
          echo "[SUCCESS] SDK extracted successfully"

      - name: Configure feeds and PassWall sources
        working-directory: openwrt-sdk
        run: |
          set -e
          echo "=========================================="
          echo "Configuring feeds"
          echo "=========================================="
          if [ -f feeds.conf.default ]; then
            cp feeds.conf.default feeds.conf
            echo "[SUCCESS] Copied feeds.conf.default to feeds.conf"
          else
            echo "[WARNING] feeds.conf.default not found, creating minimal feeds.conf" >&2
            # Create minimal feeds.conf with packages and luci feeds
            # Using default branches (no version specified) allows OpenWrt SDK to automatically
            # select the appropriate branch based on the SDK version, ensuring compatibility.
            # This is the recommended approach for OpenWrt SDK builds.
            echo "src-git packages https://github.com/openwrt/packages.git" > feeds.conf
            echo "src-git luci https://github.com/openwrt/luci.git" >> feeds.conf
            echo "[SUCCESS] Created minimal feeds.conf with packages and luci feeds"
          fi
          
          echo "Current feeds.conf:"
          cat feeds.conf
          
          # Function to update feeds with retry logic
          update_feeds_with_retry() {
            local max_retries=3
            local retry_delay=30
            
            for attempt in $(seq 1 $max_retries); do
              echo "[Attempt $attempt/$max_retries] Updating feeds..."
              if ./scripts/feeds update -a; then
                echo "[SUCCESS] Feeds updated successfully"
                return 0
              else
                echo "[WARNING] Feeds update failed on attempt $attempt"
                if [ $attempt -lt $max_retries ]; then
                  echo "Waiting ${retry_delay}s before retry..."
                  sleep $retry_delay
                  retry_delay=$((retry_delay * 2))
                fi
              fi
            done
            
            echo "[ERROR] All retry attempts failed, trying GitHub mirrors..."
            
            # Replace git.openwrt.org URLs with GitHub mirror URLs in feeds.conf
            if [ -f feeds.conf ]; then
              echo "[INFO] Switching to GitHub mirrors..."
              sed -i \
                -e 's|https://git.openwrt.org/openwrt/openwrt.git|https://github.com/openwrt/openwrt.git|g' \
                -e 's|https://git.openwrt.org/feed/packages.git|https://github.com/openwrt/packages.git|g' \
                -e 's|https://git.openwrt.org/project/luci.git|https://github.com/openwrt/luci.git|g' \
                -e 's|https://git.openwrt.org/feed/routing.git|https://github.com/openwrt/routing.git|g' \
                -e 's|https://git.openwrt.org/feed/telephony.git|https://github.com/openwrt/telephony.git|g' \
                feeds.conf
              
              echo "[INFO] Updated feeds.conf with GitHub mirrors:"
              cat feeds.conf
              echo ""
              
              echo "[INFO] Retrying with GitHub mirrors..."
              if ./scripts/feeds update -a; then
                echo "[SUCCESS] Feeds updated successfully using GitHub mirrors"
                return 0
              fi
            fi
            
            echo "[ERROR] Failed to update feeds even with GitHub mirrors"
            return 1
          }
          
          echo "Updating base feeds..."
          update_feeds_with_retry
          
          echo ""
          echo "=========================================="
          echo "Setting up PassWall sources"
          echo "=========================================="
          rm -rf feeds/packages/net/{xray-core,v2ray-geodata,sing-box,chinadns-ng,dns2socks,hysteria,ipt2socks,microsocks,naiveproxy,shadowsocks-libev,shadowsocks-rust,shadowsocksr-libev,simple-obfs,tcping,trojan-plus,tuic-client,v2ray-plugin,xray-plugin,geoview,shadow-tls}
          
          echo "Cloning openwrt-passwall-packages..."
          git clone --depth=1 https://github.com/Openwrt-Passwall/openwrt-passwall-packages package/passwall-packages
          
          rm -rf feeds/luci/applications/luci-app-passwall
          echo "Cloning openwrt-passwall (luci)..."
          git clone --depth=1 https://github.com/Openwrt-Passwall/openwrt-passwall package/passwall-luci
          
          if [ -n "${PASSWALL_LUCI_REF:-}" ]; then
            echo "Checking out PASSWALL_LUCI_REF: $PASSWALL_LUCI_REF"
            git -C package/passwall-luci fetch --all --tags
            git -C package/passwall-luci checkout "$PASSWALL_LUCI_REF"
          fi
          echo "[SUCCESS] PassWall sources configured"

      - name: Install build dependencies
        working-directory: openwrt-sdk
        run: |
          set -e
          echo "=========================================="
          echo "Installing build dependencies"
          echo "=========================================="
          ./scripts/feeds update -i
          
          echo "Verifying system toolchain versions..."
          echo "System Go version (will be used for compilation):"
          go version || echo "[WARNING] Go not found in PATH"
          echo "System Rust version (will be used for compilation):"
          rustc --version || echo "[WARNING] Rust not found in PATH"
          cargo --version || echo "[WARNING] Cargo not found in PATH"
          
          echo ""
          echo "NOTE: Go 1.25.6 and Rust were installed system-wide in previous steps"
          echo "NOTE: We do NOT install golang or rust packages from feeds because:"
          echo "  1. Feeds golang (1.23.12) is too old for xray-core (requires >= 1.25.6)"
          echo "  2. Building Rust compiler from feeds takes too long and often fails in CI"
          echo "  3. OpenWrt SDK will automatically use system Go and Rust from PATH"
          echo ""
          
          echo "Installing runtime dependencies..."
          ./scripts/feeds install \
            libev libmbedtls libsodium libopenssl libpcre2 libudns \
            boost boost-program_options boost-system \
            ca-bundle c-ares pcre2 zlib libubox libubus \
            rpcd rpcd-mod-file rpcd-mod-ucode ucode ucode-mod-fs ucode-mod-uci \
            ucode-mod-ubus ucode-mod-math libucode \
            coreutils coreutils-base64 coreutils-nohup curl dnsmasq-full ip-full \
            libuci-lua luci-compat luci-lib-jsonc resolveip luci-lua-runtime \
            iwinfo openssl libnl-tiny
          
          echo "Installing LuCI base..."
          ./scripts/feeds install luci-base
          
          echo "Installing luci-app-passwall..."
          ./scripts/feeds install luci-app-passwall
          echo "[SUCCESS] Dependencies installed"

      - name: Configure build options
        working-directory: openwrt-sdk
        run: |
          set -e
          echo "=========================================="
          echo "Configuring build options"
          echo "=========================================="
          echo "Running defconfig..."
          yes '' | make defconfig
          
          echo "Enabling PassWall packages in config..."
          cat >> .config << 'EOF'
          CONFIG_PACKAGE_chinadns-ng=m
          CONFIG_PACKAGE_dns2socks=m
          CONFIG_PACKAGE_geoview=m
          CONFIG_PACKAGE_hysteria=m
          CONFIG_PACKAGE_ipt2socks=m
          CONFIG_PACKAGE_microsocks=m
          CONFIG_PACKAGE_naiveproxy=m
          CONFIG_PACKAGE_shadow-tls=m
          CONFIG_PACKAGE_shadowsocks-rust-sslocal=m
          CONFIG_PACKAGE_shadowsocks-rust-ssserver=m
          CONFIG_PACKAGE_shadowsocksr-libev-ssr-local=m
          CONFIG_PACKAGE_shadowsocksr-libev-ssr-redir=m
          CONFIG_PACKAGE_shadowsocksr-libev-ssr-server=m
          CONFIG_PACKAGE_simple-obfs-client=m
          CONFIG_PACKAGE_sing-box=m
          CONFIG_PACKAGE_tcping=m
          CONFIG_PACKAGE_trojan-plus=m
          CONFIG_PACKAGE_tuic-client=m
          CONFIG_PACKAGE_v2ray-geoip=m
          CONFIG_PACKAGE_v2ray-geosite=m
          CONFIG_PACKAGE_v2ray-plugin=m
          CONFIG_PACKAGE_xray-core=m
          CONFIG_PACKAGE_xray-plugin=m
          EOF
          yes '' | make defconfig
          echo "[SUCCESS] Build configured"

      - name: Compile host tools
        working-directory: openwrt-sdk
        run: |
          set -e
          echo "=========================================="
          echo "Compiling luci-base host tools"
          echo "=========================================="
          make package/feeds/luci/luci-base/host/compile V=s
          echo "[SUCCESS] Host tools compiled"

      - name: Compile luci-app-passwall
        working-directory: openwrt-sdk
        run: |
          set -e
          echo "=========================================="
          echo "Compiling luci-app-passwall"
          echo "=========================================="
          make package/luci-app-passwall/compile -j"$(nproc)" V=s || {
            echo "[WARNING] Parallel build failed, retrying with single thread"
            make package/luci-app-passwall/compile V=s
          }
          echo "[SUCCESS] luci-app-passwall compiled"

      - name: Compile dependency packages
        working-directory: openwrt-sdk
        run: |
          set -e
          echo "=========================================="
          echo "Building PassWall dependency packages"
          echo "=========================================="
          
          PASSWALL_DEPS="chinadns-ng dns2socks geoview hysteria ipt2socks microsocks naiveproxy \
            shadow-tls shadowsocks-libev shadowsocks-rust shadowsocksr-libev simple-obfs sing-box tcping \
            trojan-plus tuic-client v2ray-geodata v2ray-plugin xray-core xray-plugin"
          
          for pkg in $PASSWALL_DEPS; do
            echo ""
            echo "--- Building: $pkg ---"
            PKG_PATH=""
            if [ -d "package/passwall-packages/$pkg" ]; then
              PKG_PATH="package/passwall-packages/$pkg"
            elif [ -d "package/$pkg" ]; then
              PKG_PATH="package/$pkg"
            fi
            
            if [ -n "$PKG_PATH" ]; then
              make "$PKG_PATH/compile" -j"$(nproc)" V=s 2>&1 || {
                echo "[WARNING] Failed to compile $pkg (parallel), trying single thread"
                make "$PKG_PATH/compile" V=s 2>&1 || {
                  echo "[WARNING] Failed to compile $pkg, skipping"
                }
              }
            else
              echo "[WARNING] Package $pkg not found in expected locations"
            fi
          done
          
          echo ""
          echo "--- Building: luci-i18n-passwall-zh-cn ---"
          make package/luci-i18n-passwall-zh-cn/compile -j"$(nproc)" || true
          
          echo ""
          echo "=========================================="
          echo "Skipping global package install/index to avoid building unrelated packages"
          echo "=========================================="
          
          # List what was actually built
          echo ""
          echo "Checking built packages:"
          find bin/packages -name "*.apk" -type f | head -20 || echo "No .apk files found"
          
          echo "[SUCCESS] Dependency package compilation completed"

      - name: Prepare version parser
        run: |
          cat > "$GITHUB_WORKSPACE/extract-version.sh" <<'SH'
          extract_version() {
            local filename="$1"
            local prefix="$2"
            filename=$(basename "$filename")
            local base="${filename%.apk}"
            if [ -n "$prefix" ]; then
              base="${base#${prefix}}"
              base="${base#-}"
              base="${base#_}"
            fi
            if printf "%s" "$base" | grep -q -- '_all$'; then
              base="${base%_all}"
            elif printf "%s" "$base" | grep -q -- '-all$'; then
              base="${base%-all}"
            elif printf "%s" "$base" | grep -q -- '_[^_]*$'; then
              base="$(printf "%s" "$base" | sed -E 's/_[^_]+$//')"
            fi
            echo "$base"
          }
          SH

      - name: Collect compiled packages
        working-directory: openwrt-sdk
        # Use bash for compgen glob checks in this step.
        shell: bash
        run: |
          set -e
          echo "=========================================="
          echo "Collecting built packages"
          echo "=========================================="
          
          mkdir -p "$GITHUB_WORKSPACE/payload" "$GITHUB_WORKSPACE/payload/depends"
          mkdir -p "$GITHUB_WORKSPACE/built-packages"
          
          find bin/packages \( -name "luci-app-passwall-*.apk" -o -name "luci-app-passwall_*.apk" \) -exec cp {} "$GITHUB_WORKSPACE/payload/" \;
          find bin/packages \( -name "luci-i18n-passwall-zh-cn-*.apk" -o -name "luci-i18n-passwall-zh-cn_*.apk" \) -exec cp {} "$GITHUB_WORKSPACE/payload/" \; 2>/dev/null || echo "[INFO] Chinese i18n package not found (non-critical)"
          
          echo "Main packages collected:"
          ls -lh "$GITHUB_WORKSPACE/payload/"*.apk 2>/dev/null || echo "  No main packages found"
          
          # PassWall dependency packages compiled from SDK source
          DEPENDENCY_PATTERNS="chinadns-ng dns2socks geoview hysteria ipt2socks microsocks naiveproxy \
            shadow-tls shadowsocks-libev-ss-local shadowsocks-libev-ss-redir shadowsocks-libev-ss-server \
            shadowsocks-rust-sslocal shadowsocks-rust-ssserver \
            shadowsocksr-libev-ssr-local shadowsocksr-libev-ssr-redir shadowsocksr-libev-ssr-server \
            simple-obfs-client sing-box tcping trojan-plus tuic-client \
            v2ray-geoip v2ray-geosite v2ray-plugin xray-core xray-plugin"
          
          echo ""
          echo "Searching for dependency packages in bin/packages..."
          echo "Directory structure:"
          find bin/packages -type d | head -10
          
          source "$GITHUB_WORKSPACE/extract-version.sh"

          for pkg_name in $DEPENDENCY_PATTERNS; do
            find bin/packages -type f \( -name "${pkg_name}_*.apk" -o -name "${pkg_name}-*.apk" \) -exec cp {} "$GITHUB_WORKSPACE/built-packages/" \;
          done
          
          echo "Built packages found: $(find "$GITHUB_WORKSPACE/built-packages/" -name "*.apk" 2>/dev/null | wc -l)"
          
          echo ""
          echo "=========================================="
          echo "Selecting compiled packages"
          echo "=========================================="
          printf "%-35s %-15s\n" "Package" "Version"
          printf "%-35s %-15s\n" "-----------------------------------" "---------------"
          
          for pkg_prefix in $DEPENDENCY_PATTERNS; do
            BUILT_PKG=""
            BUILT_VER=""
            
            for f in "$GITHUB_WORKSPACE/built-packages/${pkg_prefix}_"*.apk "$GITHUB_WORKSPACE/built-packages/${pkg_prefix}-"*.apk; do
              if [ -e "$f" ]; then
                BUILT_PKG="$f"
                BUILT_VER=$(extract_version "$f" "$pkg_prefix")
                break
              fi
            done
            
            if [ -n "$BUILT_PKG" ]; then
              printf "%-35s %-15s\n" "$pkg_prefix" "$BUILT_VER"
              cp "$BUILT_PKG" "$GITHUB_WORKSPACE/payload/depends/"
            else
              printf "%-35s %-15s\n" "$pkg_prefix" "(none)"
            fi
          done
          
          echo ""
          echo "=========================================="
          echo "Package Collection Summary"
          echo "=========================================="
          MISSING_PKGS=""
          for pkg_prefix in $DEPENDENCY_PATTERNS; do
            if [ -z "$(find "$GITHUB_WORKSPACE/payload/depends" -maxdepth 1 -type f \( -name "${pkg_prefix}-*.apk" -o -name "${pkg_prefix}_*.apk" \) -print -quit 2>/dev/null)" ]; then
              MISSING_PKGS="$MISSING_PKGS $pkg_prefix"
            fi
          done
          
          if [ -n "$MISSING_PKGS" ]; then
            echo "[INFO] The following packages are missing and will not be in the installer:"
            for pkg in $MISSING_PKGS; do
              echo "  - $pkg"
            done
            echo ""
            echo "[INFO] These packages may have failed to compile in the SDK build."
          else
            echo "[SUCCESS] All dependency packages collected successfully!"
          fi

      - name: Validate final packages
        run: |
          set -e
          echo "=========================================="
          echo "Validating final packages"
          echo "=========================================="
          
          DEP_COUNT=$(find "$GITHUB_WORKSPACE/payload/depends/" -name "*.apk" | wc -l)
          
          if [ "$DEP_COUNT" -eq 0 ]; then
            echo "[ERROR] No dependency APK files found in payload/depends" >&2
            echo "[INFO] Dependency compilation did not produce any packages" >&2
            exit 1
          fi
          
          # Package count explanation:
          # DEPENDENCY_PATTERNS lists 26 PassWall dependency package patterns.
          # Go 1.25.6 and Rust are now installed system-wide from official sources.
          # Most packages should compile successfully with proper toolchains.
          # Minimum expected: 10 packages (some may fail to compile)
          # With all packages compiled: up to 26 packages
          MIN_EXPECTED_PACKAGES=10
          if [ "$DEP_COUNT" -lt "$MIN_EXPECTED_PACKAGES" ]; then
            echo "[WARNING] Only $DEP_COUNT dependency packages found (expected $MIN_EXPECTED_PACKAGES-26)"
            echo "[INFO] Some packages may have failed to compile"
          fi
          
          echo ""
          echo "Main packages:"
          find "$GITHUB_WORKSPACE/payload/" -maxdepth 1 -name "*.apk" | xargs -r -n1 basename | sort | sed 's/^/  - /'
          echo ""
          echo "Dependency packages (total: $DEP_COUNT):"
          ls -1 "$GITHUB_WORKSPACE/payload/depends/" | sort | sed 's/^/  - /'
          echo ""
          echo "[SUCCESS] Package validation completed"

      - name: Validate payload
        # Use bash for compgen glob checks in this step.
        shell: bash
        run: |
          ls -l payload
          test -f payload/install.sh
          if [ -z "$(find payload -maxdepth 1 -type f \( -name 'luci-app-passwall-*.apk' -o -name 'luci-app-passwall_*.apk' \) -print -quit 2>/dev/null)" ]; then
            echo "[ERROR] luci-app-passwall package not found in payload" >&2
            exit 1
          fi
          # luci-i18n-passwall-zh-cn may fail to compile due to SDK Kconfig issues - make it optional
          if [ -z "$(find payload -maxdepth 1 -type f \( -name 'luci-i18n-passwall-zh-cn-*.apk' -o -name 'luci-i18n-passwall-zh-cn_*.apk' \) -print -quit 2>/dev/null)" ]; then
            echo "[INFO] Chinese i18n package not found - continuing without it"
          fi
          test -d payload/depends

      - name: Prepare payload
        run: |
          mkdir -p build/payload
          cp -r payload/* build/payload/
          chmod +x build/payload/install.sh

      - name: Build self-extracting installer
        run: |
          cd build
          # 从 luci-app-passwall_*.apk 文件名中抽取版本号，例如：
          # luci-app-passwall_26.1.25-r1_all.apk -> 26.1.25
          source "$GITHUB_WORKSPACE/extract-version.sh"
          PW_FILE=$(ls payload | grep -E 'luci-app-passwall[-_]' | head -n1)
          if [ -z "$PW_FILE" ]; then
            echo "[ERROR] luci-app-passwall package not found in payload" >&2
            exit 1
          fi
          PW_FULL=$(extract_version "$PW_FILE" "luci-app-passwall")
          PW_VER=${PW_FULL%%-*}
          # 从 OPENWRT_SDK_URL 提取架构与 SDK 版本
          ARCH_SEG=$(echo "$OPENWRT_SDK_URL" | sed -n 's#.*/targets/\([^/]\+/[^/]\+\)/.*#\1#p')
          if [ -z "$ARCH_SEG" ]; then
            ARCH="unknown"
          else
            ARCH=$(echo "$ARCH_SEG" | tr '/' '_')
          fi

          SDK_VERSION=$(echo "$OPENWRT_SDK_URL" | sed -n 's#.*/openwrt-sdk-\([0-9.]\+\)-.*#\1#p')
          if [ -z "$SDK_VERSION" ]; then
            SDK_VERSION="unknown"
          fi

          RUN_NAME="passwall_${PW_VER}_${ARCH}_sdk_${SDK_VERSION}.run"
          LABEL="passwall_${PW_VER}_with_sdk_${SDK_VERSION}"
          echo "RUN_NAME=${RUN_NAME}" >> $GITHUB_ENV
          echo "LABEL=${LABEL}" >> $GITHUB_ENV
          makeself --nox11 \
            payload \
            "../${RUN_NAME}" \
            "${LABEL}" \
            ./install.sh

      - name: Verify installer
        run: |
          file "${RUN_NAME}"
          sh "${RUN_NAME}" --info
          sh "${RUN_NAME}" --check

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.RUN_NAME }}
          path: ${{ env.RUN_NAME }}

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          files: |
            ${{ env.RUN_NAME }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
